<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>reZero - ì œë¡œì›¨ì´ìŠ¤íŠ¸ ì»¤ë®¤ë‹ˆí‹°</title>

    <link rel="stylesheet" href="css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ğŸŒ¿ ìš°ì¸¡ ìƒë‹¨ ê³ ì •í˜• ë­í‚¹ ë°•ìŠ¤ */
        .floating-ranking {
            position: fixed; /* âœ… ìŠ¤í¬ë¡¤í•´ë„ ê³ ì • */
            top: 110px; /* âœ… ì‚´ì§ ì•„ë˜ë¡œ ë‚´ë¦¼ */
            right: 40px;
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            padding: 14px 18px;
            width: 240px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            text-align: center;
            transition: opacity 0.4s ease, transform 0.4s ease;
            border: 1px solid #e4f2e2;
        }

        .floating-ranking h3 {
            margin: 0 0 8px 0;
            color: #2a5a2c;
            font-size: 1rem;
            font-weight: 700;
        }

        .floating-ranking ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .floating-ranking li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .floating-ranking li:last-child {
            border-bottom: none;
        }

        .floating-ranking .profile {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .floating-ranking img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid #91c788;
            object-fit: cover;
        }

        .floating-ranking .name {
            font-size: 0.9rem;
            color: #2f4f2f;
        }

        .floating-ranking .score {
            font-size: 0.85rem;
            color: #4f8a47;
        }

        @media (max-width: 768px) {
            .floating-ranking {
                position: static;
                width: 100%;
                margin: 10px auto;
            }
        }
    </style>
</head>

<body>
<div id="header-placeholder"></div>

<!-- ğŸŒ¿ ì˜¤ë¥¸ìª½ ìƒë‹¨ ê³ ì •í˜• ë­í‚¹ ë°•ìŠ¤ -->
<div class="floating-ranking" id="missionRanking">
    <h3>ğŸŒ¿ ì£¼ê°„ ë¯¸ì…˜ ë­í‚¹ Top 5</h3>
    <ul id="rankingList">
        <li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
    </ul>
</div>

<section class="hero" id="hero">
    <div class="hero-content">
        <h1>í–‡ì‚´ ì•„ë˜ì˜ ì‘ì€ ì‹¤ì²œ</h1>
        <p>ë‚˜ë­‡ì ê·¸ë¦¼ì ì‚¬ì´ë¡œ ìŠ¤ë©°ë“œëŠ” ë”°ëœ»í•œ ë¹›ì²˜ëŸ¼,<br>
            reZeroì™€ í•¨ê»˜ ì§€ì† ê°€ëŠ¥í•œ ì¼ìƒì„ ë§Œë“¤ì–´ê°€ìš”.</p>
        <button onclick="location.href='/recycling-list.html'">
            â™»ï¸ ìƒí™œ ì† ì¬í™œìš©ë²• ë³´ëŸ¬ê°€ê¸°
        </button>
    </div>
</section>

<section class="stats-section" id="stats">
    <h2>íšŒì› í†µê³„</h2>
    <div class="charts-container">
        <div class="chart-box">
            <h3>ì§€ì—­ë³„ í†µê³„</h3>
            <canvas id="regionChart"></canvas>
        </div>
        <div class="chart-box">
            <h3>ë‚˜ì´ëŒ€ë³„ í†µê³„</h3>
            <canvas id="ageChart"></canvas>
        </div>
    </div>
</section>

<div id="footer-placeholder"></div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script src="js/common.js"></script>

<script>
    /* âœ… í—¤ë”/í‘¸í„° include */
    document.addEventListener("DOMContentLoaded", async () => {
        await Promise.all([
            fetch("/header.html")
            .then(r => r.text())
            .then(h => (document.getElementById("header-placeholder").innerHTML = h)),
            fetch("/footer.html")
            .then(r => r.text())
            .then(h => (document.getElementById("footer-placeholder").innerHTML = h))
        ]);
        fetchMissionRankings();
    });

    /* ğŸŒ¿ ì£¼ê°„ ë¯¸ì…˜ ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° */
    async function fetchMissionRankings() {
        try {
            const res = await fetch("/api/missions/rankings");
            if (!res.ok) throw new Error("ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            const rankings = await res.json();
            renderRankings(rankings);
        } catch (err) {
            console.error(err);
            document.getElementById("rankingList").innerHTML =
                `<li>âŒ ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>`;
        }
    }

    function renderRankings(rankings) {
        const list = document.getElementById("rankingList");
        if (!rankings || rankings.length === 0) {
            list.innerHTML = `<li>ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
            return;
        }

        const medal = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "4ï¸âƒ£", "5ï¸âƒ£"];

        list.innerHTML = rankings
        .map((r, i) => `
          <li>
            <div class="profile">
              <span>${medal[i] || r.rank}</span>
              <img src="${r.profileUrl || '/images/default-profile.png'}" alt="í”„ë¡œí•„">
              <span class="name">${r.userName || "ìµëª…"}</span>
            </div>
            <span class="score">${r.score.toFixed(1)}ì </span>
          </li>
        `)
        .join("");
    }

    /* ğŸ“Š í†µê³„ ì°¨íŠ¸ */
    async function fetchStats() {
        const regionRes = await fetch("/api/stats/region");
        const ageRes = await fetch("/api/stats/age");
        const regionData = await regionRes.json();
        const ageData = await ageRes.json();

        createDonutChart("regionChart", regionData, "ì§€ì—­ë³„ ë¹„ìœ¨", "regionChartInstance");
        createDonutChart("ageChart", ageData, "ì—°ë ¹ëŒ€ ë¹„ìœ¨", "ageChartInstance");
    }

    function createDonutChart(canvasId, data, label, chartName) {
        const ctx = document.getElementById(canvasId);
        if (window[chartName]) window[chartName].destroy();
        window[chartName] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    label: label,
                    data: Object.values(data),
                    backgroundColor: [
                        '#7fb77e', '#a9d08e', '#cfe8a9', '#e2f0cb',
                        '#91c788', '#c2e7b0', '#e5f4ce', '#b0d89a'
                    ],
                    borderWidth: 1,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#2a3d2b', font: { size: 14 } }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 2000,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) fetchStats();
        });
    }, { threshold: 0.3 });

    observer.observe(document.getElementById("stats"));
</script>
</body>
</html>
